# ğŸ—ï¸ Arquitetura: Sistema de Anexo de Documentos

## ğŸ“ VisÃ£o Geral da Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Angular)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Property Form   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  PropertyService     â”‚            â”‚
â”‚  â”‚ Component       â”‚         â”‚  - uploadDocuments() â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                              â”‚                           â”‚
â”‚         â”‚ Files[]                      â”‚ HTTP POST                 â”‚
â”‚         â”‚                              â”‚ multipart/form-data       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ API Request
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API LAYER (Netlify Functions)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  POST /api/upload-documents                                  â”‚  â”‚
â”‚  â”‚  (netlify/functions/upload-documents.js)                     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  1. Parse multipart/form-data                                â”‚  â”‚
â”‚  â”‚  2. Extract files and metadata                               â”‚  â”‚
â”‚  â”‚  3. Validate file types, sizes, count                        â”‚  â”‚
â”‚  â”‚  4. Call SupabaseDocumentStorageService                      â”‚  â”‚
â”‚  â”‚  5. Return URLs or errors                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Service Call
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              INFRASTRUCTURE LAYER (Storage Service)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SupabaseDocumentStorageService                              â”‚  â”‚
â”‚  â”‚  (src/infrastructure/storage/SupabaseDocumentStorageService) â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Methods:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ uploadDocument(buffer, fileName, companyId, propertyId)   â”‚  â”‚
â”‚  â”‚  â€¢ uploadDocuments(files[], companyId, propertyId)           â”‚  â”‚
â”‚  â”‚  â€¢ deleteDocument(url)                                        â”‚  â”‚
â”‚  â”‚  â€¢ isAvailable()                                              â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Validations:                                                 â”‚  â”‚
â”‚  â”‚  âœ“ File extensions (.pdf, .doc, .docx, .xls, .xlsx, .txt)   â”‚  â”‚
â”‚  â”‚  âœ“ File size (max 10MB)                                      â”‚  â”‚
â”‚  â”‚  âœ“ Document count (max 10)                                   â”‚  â”‚
â”‚  â”‚  âœ“ MIME type detection                                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  File Organization:                                           â”‚  â”‚
â”‚  â”‚  {company_id}/{property_id}/{timestamp}-{random}.{ext}       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Storage API
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE STORAGE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Bucket: property-documents (PUBLIC)                         â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Structure:                                                   â”‚  â”‚
â”‚  â”‚  property-documents/                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ company-1/                                               â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ property-1/                                          â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ 1673456789-123456789.pdf                        â”‚  â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€â”€ 1673456790-987654321.docx                       â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€ property-2/                                          â”‚  â”‚
â”‚  â”‚  â”‚       â””â”€â”€ 1673456791-456789123.xlsx                       â”‚  â”‚
â”‚  â”‚  â””â”€â”€ company-2/                                               â”‚  â”‚
â”‚  â”‚      â””â”€â”€ ...                                                  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Policies (RLS):                                              â”‚  â”‚
â”‚  â”‚  â€¢ Public read access                                         â”‚  â”‚
â”‚  â”‚  â€¢ Authenticated insert                                       â”‚  â”‚
â”‚  â”‚  â€¢ Owner update/delete                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ URLs Returned
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APPLICATION LAYER (Property Service)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PropertyService                                              â”‚  â”‚
â”‚  â”‚  (src/application/services/PropertyService.js)               â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â€¢ createProperty(propertyData)                              â”‚  â”‚
â”‚  â”‚  â€¢ updateProperty(id, propertyData)                          â”‚  â”‚
â”‚  â”‚    - includes documentUrls array                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Repository Call
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           INFRASTRUCTURE LAYER (Repository)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SupabasePropertyRepository                                   â”‚  â”‚
â”‚  â”‚  (src/infrastructure/repositories/SupabasePropertyRepository)â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Mapping:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ _mapToEntity(row) - DB â†’ Entity                           â”‚  â”‚
â”‚  â”‚    - document_urls â†’ documentUrls                            â”‚  â”‚
â”‚  â”‚  â€¢ _mapToRow(property) - Entity â†’ DB                         â”‚  â”‚
â”‚  â”‚    - documentUrls â†’ document_urls                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Methods:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ create(property)                                           â”‚  â”‚
â”‚  â”‚  â€¢ update(id, propertyData)                                   â”‚  â”‚
â”‚  â”‚  â€¢ findById(id)                                               â”‚  â”‚
â”‚  â”‚  â€¢ findAll()                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ SQL Query
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE DATABASE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Table: properties                                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Columns:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ id (uuid, PK)                                              â”‚  â”‚
â”‚  â”‚  â€¢ title (text)                                               â”‚  â”‚
â”‚  â”‚  â€¢ description (text)                                         â”‚  â”‚
â”‚  â”‚  â€¢ ...                                                        â”‚  â”‚
â”‚  â”‚  â€¢ image_urls (text[])                                        â”‚  â”‚
â”‚  â”‚  â€¢ document_urls (text[])  â† NEW                             â”‚  â”‚
â”‚  â”‚  â€¢ created_at (timestamptz)                                   â”‚  â”‚
â”‚  â”‚  â€¢ updated_at (timestamptz)                                   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Constraints:                                                 â”‚  â”‚
â”‚  â”‚  â€¢ check_document_urls_limit                                  â”‚  â”‚
â”‚  â”‚    CHECK (array_length(document_urls, 1) <= 10)              â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Indexes:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ idx_properties_document_urls (GIN)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Data Persisted
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DOMAIN LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Property Entity                                              â”‚  â”‚
â”‚  â”‚  (src/domain/entities/Property.js)                           â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Properties:                                                  â”‚  â”‚
â”‚  â”‚  â€¢ id                                                         â”‚  â”‚
â”‚  â”‚  â€¢ title                                                      â”‚  â”‚
â”‚  â”‚  â€¢ description                                                â”‚  â”‚
â”‚  â”‚  â€¢ ...                                                        â”‚  â”‚
â”‚  â”‚  â€¢ imageUrls: string[]                                        â”‚  â”‚
â”‚  â”‚  â€¢ documentUrls: string[]  â† NEW                             â”‚  â”‚
â”‚  â”‚  â€¢ createdAt                                                  â”‚  â”‚
â”‚  â”‚  â€¢ updatedAt                                                  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Methods:                                                     â”‚  â”‚
â”‚  â”‚  â€¢ validate()                                                 â”‚  â”‚
â”‚  â”‚  â€¢ toJSON()                                                   â”‚  â”‚
â”‚  â”‚  â€¢ fromJSON(data)                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Fluxo de Upload de Documentos

```
1. Usuario seleciona arquivos no formulÃ¡rio
   â”‚
   â”œâ”€> Frontend valida (opcional)
   â”‚
2. Frontend chama PropertyService.uploadDocuments()
   â”‚
   â”œâ”€> Cria FormData com arquivos
   â”œâ”€> Adiciona company_id, property_id
   â”‚
3. HTTP POST /api/upload-documents
   â”‚
   â”œâ”€> Netlify Function recebe request
   â”œâ”€> Parse multipart/form-data
   â”œâ”€> Extrai arquivos e metadata
   â”‚
4. SupabaseDocumentStorageService.uploadDocuments()
   â”‚
   â”œâ”€> Para cada arquivo:
   â”‚   â”œâ”€> Valida extensÃ£o
   â”‚   â”œâ”€> Valida tamanho
   â”‚   â”œâ”€> Gera nome Ãºnico
   â”‚   â”œâ”€> Determina MIME type
   â”‚   â””â”€> Upload para Supabase Storage
   â”‚
5. Retorna array de URLs
   â”‚
   â”œâ”€> Frontend recebe URLs
   â”‚
6. Frontend adiciona URLs ao property.documentUrls
   â”‚
7. Ao salvar propriedade:
   â”‚
   â”œâ”€> PropertyService.createProperty() ou updateProperty()
   â”œâ”€> PropertyService chama backend
   â”œâ”€> SupabasePropertyRepository.create() ou update()
   â”œâ”€> Salva document_urls no banco
   â”‚
8. Dados persistidos no Supabase
```

## ğŸ” ValidaÃ§Ãµes e SeguranÃ§a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Camadas de ValidaÃ§Ã£o                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Frontend (Opcional)                                      â”‚
â”‚     â€¢ ValidaÃ§Ã£o de tipo de arquivo                          â”‚
â”‚     â€¢ Preview de arquivos                                    â”‚
â”‚     â€¢ Limite visual de 10 documentos                        â”‚
â”‚                                                              â”‚
â”‚  2. API Endpoint                                             â”‚
â”‚     â€¢ Content-Type verification                              â”‚
â”‚     â€¢ Multipart parsing                                      â”‚
â”‚     â€¢ File filtering                                         â”‚
â”‚     â€¢ Document count limit (max 10)                         â”‚
â”‚                                                              â”‚
â”‚  3. Storage Service                                          â”‚
â”‚     â€¢ Extension validation (.pdf, .doc, etc.)               â”‚
â”‚     â€¢ File size validation (max 10MB)                       â”‚
â”‚     â€¢ MIME type detection                                    â”‚
â”‚     â€¢ Filename sanitization                                  â”‚
â”‚                                                              â”‚
â”‚  4. Supabase Storage                                         â”‚
â”‚     â€¢ RLS Policies                                           â”‚
â”‚     â€¢ Bucket permissions                                     â”‚
â”‚     â€¢ File organization                                      â”‚
â”‚                                                              â”‚
â”‚  5. Database                                                 â”‚
â”‚     â€¢ Array length constraint (max 10)                      â”‚
â”‚     â€¢ Data type validation (text[])                         â”‚
â”‚     â€¢ GIN index for performance                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Formatos Suportados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ExtensÃ£o â”‚ Tipo            â”‚ MIME Type                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .pdf     â”‚ PDF             â”‚ application/pdf                      â”‚
â”‚ .doc     â”‚ Word 97-2003    â”‚ application/msword                   â”‚
â”‚ .docx    â”‚ Word            â”‚ application/vnd.openxmlformats-...   â”‚
â”‚ .xls     â”‚ Excel 97-2003   â”‚ application/vnd.ms-excel             â”‚
â”‚ .xlsx    â”‚ Excel           â”‚ application/vnd.openxmlformats-...   â”‚
â”‚ .txt     â”‚ Texto           â”‚ text/plain                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ Estrutura de Dados

### Database Schema
```sql
ALTER TABLE properties 
ADD COLUMN document_urls text[];

ALTER TABLE properties 
ADD CONSTRAINT check_document_urls_limit 
CHECK (array_length(document_urls, 1) IS NULL OR array_length(document_urls, 1) <= 10);

CREATE INDEX idx_properties_document_urls 
ON properties USING GIN (document_urls);
```

### Domain Model
```javascript
class Property {
  constructor() {
    this.documentUrls = []; // Array de URLs
  }
}
```

### Frontend Model
```typescript
interface Property {
  documentUrls?: string[];
}
```

## ğŸ¯ Endpoints da API

### Upload de Documentos
```
POST /api/upload-documents

Headers:
  Content-Type: multipart/form-data

Body (FormData):
  documents: File[]
  company_id: string (opcional)
  property_id: string (opcional)

Response Success (200):
{
  "documentUrls": [
    "https://xxx.supabase.co/storage/v1/object/public/property-documents/company/property/123.pdf"
  ],
  "allowedExtensions": [".pdf", ".doc", ".docx", ".xls", ".xlsx", ".txt"]
}

Response Error (400):
{
  "error": "Tipo de arquivo nÃ£o permitido",
  "details": { ... }
}
```

### Criar/Atualizar Propriedade
```
POST /api/properties
PUT /api/properties/:id

Body:
{
  "title": "...",
  "description": "...",
  "documentUrls": [
    "https://xxx.supabase.co/storage/.../document1.pdf",
    "https://xxx.supabase.co/storage/.../document2.docx"
  ]
}
```

## ğŸ§© Componentes do Sistema

```
Backend Components:
â”œâ”€â”€ Domain Layer
â”‚   â””â”€â”€ Property Entity (documentUrls field)
â”œâ”€â”€ Application Layer
â”‚   â””â”€â”€ PropertyService (handles document URLs)
â”œâ”€â”€ Infrastructure Layer
â”‚   â”œâ”€â”€ SupabasePropertyRepository (document_urls mapping)
â”‚   â””â”€â”€ SupabaseDocumentStorageService (upload logic)
â””â”€â”€ API Layer
    â””â”€â”€ upload-documents.js (Netlify Function)

Database:
â”œâ”€â”€ properties table
â”‚   â”œâ”€â”€ document_urls column (text[])
â”‚   â”œâ”€â”€ check_document_urls_limit constraint
â”‚   â””â”€â”€ idx_properties_document_urls index
â””â”€â”€ Migration: migration-add-document-urls.sql

Storage:
â”œâ”€â”€ property-documents bucket
â”‚   â”œâ”€â”€ Structure: {company_id}/{property_id}/{file}
â”‚   â””â”€â”€ Policies: storage-policies-property-documents.sql
â””â”€â”€ Files: PDF, DOC, DOCX, XLS, XLSX, TXT

Frontend:
â”œâ”€â”€ Property Model (documentUrls field)
â””â”€â”€ PropertyService (uploadDocuments method)

Documentation:
â”œâ”€â”€ TESTE_DOCUMENTOS.md (testing guide)
â”œâ”€â”€ BACKEND_IMPLEMENTATION_SUMMARY.md (summary)
â””â”€â”€ DOCUMENT_ARCHITECTURE.md (this file)
```

---

**VersÃ£o**: 1.0.0  
**Data**: 2026-01-06  
**Status**: âœ… Completo
